
---

# across-stats

Скрипт для обработки и объединения данных из Excel-файла `mtb_table.xlsx` с информацией, полученной из NCBI, и данными анализа качества, полученными с помощью сторонних пайплайнов.

## Описание

Данный скрипт выполняет следующие задачи:

- **Подготовка входных данных:**
  - Необходимо предварительно скачать CSV-файл с данными от NCBI, содержащий информацию о fastq файлах.
  - На основе скачанного CSV-файла и данных из результатов работы пайплайна (см. ниже) необходимо создать Excel-файл `mtb_table.xlsx` с **трёх листами**.  
  - **Ключевой лист – `ncbi`:** именно с ним производится объединение (мердж) данных.  
  - Остальные листы (например, `data6` и `data15`) следует получить из результатов работы скриптов либо из проекта [TBGenoPipe](https://github.com/dbespiatykh/TBGenoPipe), либо из [tb-vars-pipe](https://github.com/KiselevSI/tb-vars-pipe) – конкретно из файла `stats/multiqc/multiqc_data/multiqc_general_stats.txt`.
  
- **Обработка данных:**
  - Чтение данных из Excel-файла с использованием библиотеки **readxl**.
  - Приведение значений столбца `tstv` к числовому типу.
  - Объединение данных из листов (например, `data6` и `data15`), с удалением дубликатов по полю `Sample`.
  - Левое объединение с листом `ncbi` по совпадению значений полей `Run` (из `ncbi`) и `Sample` (из объединённых листов).
  - Преобразование всех столбцов в тип `character` и замена отсутствующих значений (`NA`) на пустые строки.
  - Экспорт итоговых данных в форматы TSV и XLSX.

## Требования

Перед запуском скрипта убедитесь, что установлены следующие R-пакеты:

- **readxl**
- **dplyr**
- **openxlsx** (при отсутствии пакет будет установлен автоматически)

## Подготовка входных данных

1. **Скачивание данных NCBI:**
   - Скачайте CSV-файл, содержащий информацию о fastq файлах, предоставляемую NCBI.
2. **Создание Excel-файла `mtb_table.xlsx`:**
   - Создайте Excel-файл с тремя листами:
     - **ncbi** – основной лист, содержащий данные из CSV-файла.
     - Остальные листы (например, `data6` и `data15`) – данные, полученные из результата работы одного из следующих пайплайнов:
       - [TBGenoPipe](https://github.com/dbespiatykh/TBGenoPipe)
       - [tb-vars-pipe](https://github.com/KiselevSI/tb-vars-pipe) (файл: `results/stats/multiqc/multiqc_data/multiqc_general_stats.txt`)

## Установка

1. Клонируйте репозиторий:
   ```bash
   git clone https://github.com/your-username/across-stats.git
   ```
2. Перейдите в директорию проекта:
   ```bash
   cd across-stats
   ```

## Использование

1. Убедитесь, что файл `mtb_table.xlsx` находится в вашем пути  или измените путь в скрипте при необходимости.
2. Запустите скрипт в R или RStudio:
   ```R
   source("merge_ncbi_data.R")
   ```

После выполнения скрипта в текущей директории появятся файлы:

- `across-stats.tsv`
- `across-stats.xlsx`

## Структура проекта

- **merge_ncbi_data.R** – основной скрипт для обработки и объединения данных.
- **mtb_table.xlsx** – входной файл с данными, содержащий 3 листа (в том числе ключевой лист `ncbi`).
- **README.md** – данный файл с описанием проекта.

